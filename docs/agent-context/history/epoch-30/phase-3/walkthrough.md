# Phase 1 Walkthrough: AI Context

## Goal

Create `llms.txt` and `llms-full.txt` to provide standardized context for AI coding assistants.

## Implementation

### 1. Generation Script

Created `scripts/generate-llms-txt.ts` which:

- Aggregates key documentation files for `llms.txt` (Axioms, Concepts, Quick Start, CLI, JS API, CSS Utilities).
- Aggregates ALL documentation files for `llms-full.txt`.
- Strips frontmatter and cleans up MDX components (Tabs, Cards) to make the text cleaner for LLMs.
- Includes `css/utilities.css` as a reference for available utility classes.

### 2. Build Integration

Updated `scripts/build-site.ts` to run the generation script before building the Astro site. This ensures the files are always up-to-date in production.

### 3. Configuration Updates

- Updated `src/lib/defaults.ts` to use `axm` as the default prefix, aligning with the "Axiomatic Color" rebrand.
- Updated `scripts/surface-lightness.config.json` to explicitly use `prefix: "axm"`, fixing a test failure in `build.test.ts`.

### 4. Verification

Created `tests/llm-context.spec.ts` to verify that:

- The files are generated.
- They contain key sections (Axioms, Thinking in Surfaces, CSS Utilities).
- They are free of frontmatter artifacts.

## Key Decisions

- **CSS Utilities as Reference**: Instead of just raw JSON tokens, we included `css/utilities.css` in the summary because it shows the _usage_ (class names) which is more valuable for an LLM trying to write code.
- **Default Prefix Change**: Changed default prefix from `color-sys` to `axm` to enforce the new brand identity.

## Next Steps

Proceed to Phase 2: The CI Gatekeeper.

## Phase 2: CI Gatekeeper (Audit Hardening)

### Context

The user requested a "separate verification tool" for `color-config.json` instead of complex ESLint plugins. The existing `axiomatic audit` command performed some logic checks but lacked structural validation.

### Implementation

We integrated `ajv` (Another JSON Schema Validator) into the `audit` command to validate the configuration against `color-config.schema.json`.

#### Key Decisions

1. **Runtime Validation**: We chose to validate at runtime using the schema generated by `ts-json-schema-generator`. This ensures the config matches the TypeScript types exactly.
2. **Schema Patching**: The generated schema uses `additionalProperties: false`, which flags the `$schema` property as invalid. We implemented a runtime patch to allow `$schema` in the root object, as it is essential for editor Intellisense.
3. **Strict Mode**: We disabled Ajv's strict mode warnings to prevent noise about "union types" in the generated schema, while keeping the validation logic intact.
4. **Polyfills**: We used a polyfill for `__dirname` (`dirname(fileURLToPath(import.meta.url))`) to ensure compatibility with the ESM environment in Node 24.

### Verification

- Ran `pnpm run audit:theme` against the valid `color-config.json` -> Passed.
- Verified that invalid properties trigger a schema error.

## Phase 3: The Editor Companion (VS Code Extension)

### Context

The user requested "Where are the classes?" tooling to improve the developer experience. We decided to build a VS Code extension that provides autocompletion and visual feedback for Axiomatic utility classes.

### Implementation

#### 1. Scaffolding

Initialized a new package `@axiomatic-design/vscode-extension` in `packages/vscode-extension`.

- Configured `tsup` to bundle the extension code.
- Configured `package.json` with the necessary VS Code extension metadata (activation events, contribution points).
- Added the package to the `pnpm-workspace.yaml`.

#### 2. Grammar Specification

Created `docs/design/editor-grammar-spec.md` to define the formal Tree-sitter queries for detecting class names in various languages (HTML, JSX, Svelte, Vue, Lit, Ember).

- **Decision**: We chose `web-tree-sitter` over Regex or a full Language Server Protocol (LSP) implementation. Tree-sitter provides a robust AST that can handle complex nesting and framework-specific syntax without the overhead of a full LSP.
- **Reverse Inference**: The spec includes logic for "Reverse Inference" to trace variables back to their definitions, allowing us to support dynamic class names.

#### 3. Infrastructure (WASM)

Implemented `scripts/setup-grammars.js` to manage Tree-sitter WASM binaries.

- Downloads/Copies `tree-sitter.wasm` and language grammars (`html`, `css`, `javascript`, `typescript`, `tsx`, `vue`) into the `grammars/` directory.
- Configured `Parser.init()` to load these binaries dynamically at runtime.

#### 4. Autocomplete

Implemented `AxiomaticCompletionProvider` (`src/completion.ts`).

- Uses Tree-sitter queries to detect if the cursor is inside a "Class Name Context" (e.g., `class="..."`, `className="..."`).
- Provides completion items for all tokens defined in `src/tokens.ts` (generated from the system's CSS).

#### 5. Decorators (Color Swatches)

Implemented `AxiomaticDecorator` (`src/decorator.ts`).

- Scans the document for known token class names.
- Renders a color swatch (square) next to the class name using `vscode.window.createTextEditorDecorationType`.
- Uses a generated `color-map.json` to resolve token names to `oklch` values.

### Verification

- Verified the extension builds with `pnpm compile`.
- Verified that `tree-sitter` initializes correctly.
