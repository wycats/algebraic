# Walkthrough - Epoch 17: Theme Builder V2

## Phase 1: Integration & Architecture

We started by auditing the existing `site/src/components/builder` directory and identifying the key components needed for the V2 overhaul. We decided to focus on "Data Density" and "Visualization" as the primary drivers for this epoch.

## Phase 2: Visualization & Education

### Data Density

We updated `SurfaceRow.svelte` to display the calculated LCH and Hex values for each surface. This provides immediate feedback to the user about the actual color values being generated by the solver. We used the `culori` library to handle color conversions and added a copy-to-clipboard feature for the Hex values.

### Visualizer Graph

We created a new component, `VisualizerGraph.svelte`, to visualize the hierarchical structure of the theme.

- **Structure**: The graph renders a tree starting from the "Root" (Theme), branching into "Groups", and finally into "Surfaces".
- **Visualization**: Each node in the graph displays its name and a color swatch representing its resolved color.
- **Integration**: We integrated this graph into the main `ThemeBuilder.svelte` component using a tabbed interface. Users can now toggle between the standard "Preview" mode and the new "Graph" mode to see the underlying structure of their theme.

### Anchors Editor Redesign

We overhauled the `AnchorsEditor.svelte` to improve space efficiency and data density, applying lessons from the `SurfaceRow` improvements.

- **Compact Layout**: Grouped controls into "Page" and "Inverted" cards.
- **Data Density**: Integrated start/end values directly into the control headers, removing redundant vertical space.
- **Visual Hierarchy**: Used clearer typography and spacing to distinguish between Polarities and Modes.

### Interactive Anchor Graph

We implemented a new `AnchorGraph.svelte` component that visualizes the anchor ranges on two separate lightness tracks.

- **Visualization**: Displays "Page Context" and "Inverted Context" on separate tracks to reduce visual clutter and improve readability.
- **Ranges**: Each track shows the Light Mode and Dark Mode ranges as semi-transparent bars directly on the gradient.
- **Interactivity**: Users can drag the start and end handles of each range directly on the graph to adjust the values.
- **Design**: Uses a "bar" style visualization with clear handles and labels. We refined the layout to stack the tracks vertically with clear axis labels, addressing user feedback about visual parsing and spacing.
- **Integration**: Replaced the slider-based controls in `AnchorsEditor` with this new graph. We integrated the numerical values directly into the graph labels, allowing us to remove the redundant read-only cards below the graph.
- **Sync Logic**: Added a "Sync Dark Mode" feature (enabled by default) that automatically updates the Dark Mode range to maintain equivalent **Contrast (Lc)** values relative to the text color. When Light Mode anchors are adjusted, the system calculates the contrast delta and applies it to the Dark Mode anchors, ensuring that the perceptual contrast range is preserved across modes, rather than just the linear lightness range.
- **Core Logic Refactor**: We moved the contrast synchronization logic into the core `@axiomatic-design/color` package as `syncDarkToLight`. This ensures the domain logic is reusable and testable, keeping the UI state management focused on orchestration.

### Technical Details

- **State Management**: We leveraged Svelte 5's Runes (`$state`, `$derived`) to manage the active tab state and reactive updates to the graph.
- **Color Processing**: We used `culori`'s `formatHex` and `oklch` to process color values for display.
- **CSS**: We added new styles in `ThemeBuilder.css` to support the tabbed interface and the graph layout.

## Phase 3: Polish & Infrastructure

### AnchorGraph Polish

We refined the `AnchorGraph` component based on user feedback ("comically bad" text placement).

- **Layout**: Adjusted the positioning of text labels to ensure they don't overlap with the graph bars or handles.
- **Spacing**: Improved the vertical spacing between the tracks and the labels.

### Infrastructure & CI/CD

We established a robust CI/CD pipeline to ensure code quality and prevent regressions.

- **Lefthook**: Configured `lefthook` to run pre-commit and pre-push hooks. This ensures that linting, type checking, and tests pass before code is committed or pushed.
- **GitHub Actions**: Set up a basic CI workflow to run tests on every push.

### Development Environment

We addressed issues with the local development environment.

- **Vite Aliases**: Fixed an issue where the site build was failing to resolve the `@axiomatic-design/color` package in development mode. We updated `astro.config.mjs` to alias the package to `src/lib` directly, ensuring that changes in the library are immediately reflected in the site without a rebuild.

### Documentation Upgrades

We focused on elevating the quality of the documentation to a "premium" level.

- **MathJax**: Added `remark-math` and `rehype-mathjax` to the Astro configuration to support LaTeX-style math equations in the documentation. This allows us to document the physics and math behind the color system with precision.
- **Token Level Visualizer**: We replaced the static markdown table for accessibility tokens with a new `TokenLevelVisualizer.svelte` component.
  - **Premium Design**: The visualizer uses a card-based layout with live previews of the tokens in both Light and Dark modes.
  - **Live Code**: It renders the actual CSS variable values, providing a "truthy" view of the system.
  - **Context Isolation**: We used `isolation: isolate` and `color-scheme` to correctly render the light/dark previews within the same component, ensuring that the browser's native rendering engine handles the theme switching correctly.
